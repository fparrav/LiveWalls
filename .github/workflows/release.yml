name: üöÄ Release LiveWalls

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.

env:
  APP_NAME: "LiveWalls"
  SCHEME_NAME: "LiveWalls"
  
jobs:
  build-and-release:
    runs-on: macos-latest
    
    permissions:
      contents: write  # Necesario para crear releases
      
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      
    - name: üîß Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: üìã Cache Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/.swiftpm
        key: ${{ runner.os }}-xcode-${{ hashFiles('**/*.xcodeproj', '**/*.swift') }}
        restore-keys: |
          ${{ runner.os }}-xcode-
          
    - name: üèóÔ∏è Build App
      run: |
        echo "üî® Building $APP_NAME..."
        xcodebuild \
          -project "$APP_NAME.xcodeproj" \
          -scheme "$SCHEME_NAME" \
          -configuration Release \
          -derivedDataPath ./DerivedData \
          -archivePath "./build/$APP_NAME.xcarchive" \
          archive \
          CODE_SIGN_STYLE=Automatic \
          CODE_SIGN_IDENTITY="-"
          
    - name: üì¶ Export App
      run: |
        echo "üì¶ Exporting $APP_NAME.app..."
        
        # Create ExportOptions.plist for unsigned export
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>mac-application</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>stripSwiftSymbols</key>
            <true/>
        </dict>
        </plist>
        EOF
        
        # Export the archive
        xcodebuild \
          -exportArchive \
          -archivePath "./build/$APP_NAME.xcarchive" \
          -exportPath "./build/export" \
          -exportOptionsPlist ExportOptions.plist
          
    - name:  Create DMG
      run: |
        echo "üíø Creating DMG..."
        
        # Install create-dmg if not available
        if ! command -v create-dmg &> /dev/null; then
          brew install create-dmg
        fi
        
        # Create DMG
        create-dmg \
          --volname "$APP_NAME" \
          --volicon "./icon_asset/icono-macOS-Default-1024x1024@2x.png" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "$APP_NAME.app" 200 190 \
          --hide-extension "$APP_NAME.app" \
          --app-drop-link 600 185 \
          --background "./scripts/dmg-background.png" \
          "./build/$APP_NAME-${{ github.ref_name }}.dmg" \
          "./build/export/"
          
    - name: üìã Get Release Info
      id: release_info
      run: |
        VERSION=${{ github.ref_name }}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # Obtener el tag anterior para generar changelog autom√°tico
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "$VERSION" | head -n 1)
        
        if [ -z "$PREVIOUS_TAG" ]; then
          echo "üìù Primer release - generando changelog completo"
          CHANGELOG="üéâ Primera versi√≥n de LiveWalls disponible!"
        else
          echo "üìù Generando changelog desde $PREVIOUS_TAG hasta $VERSION"
          
          # Generar changelog autom√°tico basado en conventional commits
          CHANGELOG_CONTENT=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..$VERSION 2>/dev/null || git log --pretty=format:"- %s (%h)" --since="1 month ago")
          
          # Categorizar commits por tipo
          FEATURES=$(echo "$CHANGELOG_CONTENT" | grep -E "^- (feat|feature)" | sed 's/^- //')
          FIXES=$(echo "$CHANGELOG_CONTENT" | grep -E "^- (fix|bugfix)" | sed 's/^- //')
          CHORES=$(echo "$CHANGELOG_CONTENT" | grep -E "^- (chore|docs|style|refactor|test)" | sed 's/^- //')
          OTHERS=$(echo "$CHANGELOG_CONTENT" | grep -vE "^- (feat|feature|fix|bugfix|chore|docs|style|refactor|test)" | sed 's/^- //')
          
          # Construir changelog estructurado
          CHANGELOG="## üöÄ Cambios en esta versi√≥n"
          
          if [ ! -z "$FEATURES" ]; then
            CHANGELOG="$CHANGELOG\n\n### ‚ú® Nuevas caracter√≠sticas\n$FEATURES"
          fi
          
          if [ ! -z "$FIXES" ]; then
            CHANGELOG="$CHANGELOG\n\n### üêõ Correcciones\n$FIXES"
          fi
          
          if [ ! -z "$CHORES" ]; then
            CHANGELOG="$CHANGELOG\n\n### üîß Mantenimiento\n$CHORES"
          fi
          
          if [ ! -z "$OTHERS" ]; then
            CHANGELOG="$CHANGELOG\n\n### üìù Otros cambios\n$OTHERS"
          fi
          
          # Si no hay commits categorizados, mostrar todos
          if [ -z "$FEATURES$FIXES$CHORES$OTHERS" ]; then
            CHANGELOG="## üöÄ Cambios en esta versi√≥n\n\n$CHANGELOG_CONTENT"
          fi
        fi
        
        # Verificar si existe CHANGELOG.md manual y usarlo si existe
        if [ -f CHANGELOG.md ]; then
          MANUAL_CHANGELOG=$(awk "/^## \[$VERSION\]/,/^## \[/{if(/^## \[/ && !/^## \[$VERSION\]/)exit;print}" CHANGELOG.md | head -n -1)
          if [ ! -z "$MANUAL_CHANGELOG" ]; then
            echo "üìã Usando changelog manual de CHANGELOG.md"
            CHANGELOG="$MANUAL_CHANGELOG"
          fi
        fi
        
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: üöÄ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: "LiveWalls ${{ steps.release_info.outputs.version }}"
        body: |
          ${{ steps.release_info.outputs.changelog }}
          
          ## üì• Instalaci√≥n
          
          1. Descarga el archivo `${{ env.APP_NAME }}-${{ github.ref_name }}.dmg`
          2. Abre el DMG y arrastra LiveWalls a Aplicaciones
          3. ¬°Disfruta tus fondos de pantalla din√°micos!
          
          ## üìã Requisitos
          - macOS 14.0 (Sonoma) o superior
          
          ## üîí Seguridad
          ‚ö†Ô∏è **Aplicaci√≥n sin firma digital**: Esta es una aplicaci√≥n open source distribuida sin certificado de desarrollador de Apple.
          
          Para abrir la aplicaci√≥n por primera vez:
          ```bash
          # Opci√≥n 1: Desactivar quarantine (recomendado)
          xattr -d com.apple.quarantine /Applications/LiveWalls.app
          
          # Opci√≥n 2: Ir a Preferencias > Seguridad y permitir la app
          ```
          
          üí° **Recomendaci√≥n**: Para mayor seguridad, considera compilar la aplicaci√≥n desde el c√≥digo fuente.
          
        files: |
          ./build/${{ env.APP_NAME }}-${{ github.ref_name }}.dmg
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
        
    - name: ‚úÖ Success Notification
      run: |
        echo "üéâ Release ${{ github.ref_name }} created successfully!"
        echo "üì¶ DMG: $APP_NAME-${{ github.ref_name }}.dmg"
        echo "üîó Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
